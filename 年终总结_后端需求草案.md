# 年终总结（Tracker 风格）后端需求草案

> 用途：把这份文档直接发给后端评估实现难度与工期。

## 0. 目标与范围

- **目标**：为指定用户生成某一年的「刷题/竞赛/习惯/成长/知识点」年终总结页面数据，并支持前端生成可分享卡片/海报。
- **统计范围**：仅统计该用户在系统内的提交/参赛/打卡等行为（如有导入数据，需标记来源）。
- **时间口径**：按用户时区统计自然日；`year=2025` 表示 `2025-01-01 00:00:00` ~ `2025-12-31 23:59:59`（用户时区）。
- **幂等性**：同一用户同一年重复请求，返回应稳定（除非底层数据变化）。

## 1. 前端需要的数据模块（对后端来说是“验收清单”）

1) **年度总览**
- 总提交数、总 AC 数、总解题数（去重）、通过率、活跃天数、最长连续天数
- （可选）总活跃用时、平均每日用时

2) **年度时间线（趋势）**
- 按月聚合：提交/AC/解题、活跃天数、（可选）总用时、难度中位数
- 按天聚合：用于热力图（至少提交/AC/解题三者之一）

3) **习惯与连续性**
- 最长连续天数、当前连续（如果 year 是当前年可选）、断档次数
- 常用刷题时段：小时直方图、星期分布

4) **质量与稳定性（可降级）**
- verdict 占比：AC/WA/TLE/RE/CE/…
- 首次 AC 比例、平均每题提交次数（只统计最终解出的题）

5) **难度与成长（可降级）**
- 难度分桶分布（例如 CF 段位：`<1200, 1200-1399, ...`）
- 难度随时间变化（按月中位数/分位数）

6) **知识点雷达（可降级）**
- 各 tag 覆盖题数
- 近 90 天增量（如果 year 非当前年，可按该年最后 90 天）
- Top 强项 / Top 待补

7) **竞赛回顾（可降级）**
- 参赛次数、最好 rank/分数
- rating 变化（若系统无 rating，可置空）
- 关键场次列表（title/start_at/rank/score/rating_delta）

8) **年度高光（建议必须做，用户感知强）**
- 最难题 TopN（按 difficulty 排序）
- 最多尝试 TopN（按提交次数）
- 最丝滑：一次 AC（submissions_until_ac=1）/最短耗时（若有 session）

## 2. 数据依赖（按版本拆分：MVP / 标准 / 豪华）

### 2.1 MVP（建议后端优先评估：最小可落地）

> 仅依赖“提交明细 + 题目元信息”，即可做出 70% 的年终总结。

#### A) Submit（提交明细）——必需
- `submit_id`：string/long，唯一
- `user_id`：string/long
- `problem_id`：string/long
- `created_at`：timestamp（统一 UTC 或带时区）
- `verdict`：enum（AC/WA/TLE/RE/CE/…）
- `time_used_ms`：int，可空
- `memory_used_kb`：int，可空
- `language`：string，可空
- `source`：enum，可空（practice/daily/contest/other）
- `contest_id`：string/long，可空

#### B) Problem（题目元信息）——必需
- `problem_id`
- `title`
- `url`：可空
- `difficulty`：可空（数值/枚举；若无则难度模块降级）
- `tags[]`：可空（若无则知识点模块降级）

### 2.2 标准版（让“成长解释/雷达/竞赛”更像 tracker）

#### C) ContestParticipation（参赛记录）——可选
- `user_id`
- `contest_id`
- `joined_at`：timestamp（可选）
- `rank`：int，可空
- `score`：number，可空
- `rating_delta`：number，可空

#### D) ContestMeta（竞赛元信息）——可选
- `contest_id`
- `title`
- `start_at`：timestamp
- `url`：可空

#### E) ProblemTagMap（若 Problem 没有 tags）——可选
- `problem_id`
- `tag_id`/`tag`
- `weight`：可空

### 2.3 豪华版（如果希望“用时/专注/叙事”更真实）

#### F) Session（做题会话/真实用时）——可选
- `user_id`
- `problem_id`
- `session_start`
- `session_end`
- `active_seconds`（去除挂机的活跃秒数更好）

#### G) ViewLog（打开题目/阅读行为）——可选
- `user_id, problem_id, opened_at, duration_seconds(可空)`

## 3. 统计口径（后端需要明确，避免前端各算各的）

### 3.1 “解题数（problems_solved）”
- 定义：在统计区间内**至少一次 AC** 的 `problem_id` 去重计数。
- 注意：若用户在 2024 年 AC 过，2025 年再次 AC：
  - 若做“年度解题”更符合用户直觉：**只要该年有 AC 就算**。
  - 若做“首次解出”更严格：需要额外字段 `first_ac_at`（跨年查询成本更高）。
  - **建议 MVP 采用“该年有 AC 就算”。**

### 3.2 “活跃日（active_days）”
- 定义：当天存在至少 1 次提交（或至少 1 次 AC；二选一，建议“提交”更稳定）。
- 时区：按用户时区做 date 截断。

### 3.3 “连续天数（streak）”
- 基于 `active_days` 的日期集合计算最长连续。
- 若 `source=daily` 有独立打卡口径，可同时给出 `daily_streak`（可选）。

### 3.4 “首次 AC 比例（first_ac_rate）”（可降级）
- 定义：对每个最终解出的题，若该题在区间内首次提交即 AC（或该题总提交次数=1 且 verdict=AC），则计为一次“首次 AC”。
- MVP 口径建议：**以区间内该题的首次提交是否 AC** 来近似。

### 3.5 难度分桶（示例）
- 若 difficulty 为 CF rating 数值：
  - `<1200, 1200-1399, 1400-1599, 1600-1799, 1800-1999, 2000+`
- 若 difficulty 为空：该模块返回空数组或 `null`，前端降级展示。

## 4. 推荐接口设计（聚合优先：减少前端计算与多次请求）

### 4.1 一把梭聚合接口（推荐）
- **接口**：`GET /api/summary/year?year=2025`
- **入参**：
  - `year`：int
  - （可选）`timezone`：string（默认用户配置）
- **返回**：一个 JSON，包含所有模块。

#### 返回结构（建议）

```json
{
  "year": 2025,
  "timezone": "Asia/Shanghai",
  "generated_at": "2025-12-18T12:00:00+08:00",

  "overview": {
    "problems_solved": 0,
    "submissions": 0,
    "accepted_submissions": 0,
    "accept_rate": 0.0,
    "active_days": 0,
    "longest_streak": 0,
    "total_active_seconds": null
  },

  "timeseries": {
    "by_month": [
      {
        "month": "2025-01",
        "problems_solved": 0,
        "submissions": 0,
        "accepted_submissions": 0,
        "active_days": 0,
        "median_difficulty": null,
        "total_active_seconds": null
      }
    ],
    "by_day_heatmap": [
      {
        "date": "2025-01-01",
        "problems_solved": 0,
        "submissions": 0,
        "accepted_submissions": 0,
        "active_seconds": null
      }
    ]
  },

  "habits": {
    "hour_histogram": [{"hour": 0, "submissions": 0}],
    "weekday_histogram": [{"weekday": 1, "submissions": 0}],
    "streaks": {
      "longest": 0,
      "current": null,
      "break_count": 0
    }
  },

  "quality": {
    "verdict_breakdown": [{"verdict": "AC", "count": 0}],
    "avg_submissions_per_solved_problem": 0.0,
    "first_ac_rate": null
  },

  "difficulty": {
    "bucket_breakdown": [
      {"bucket": "0-1199", "problems_solved": 0},
      {"bucket": "1200-1399", "problems_solved": 0}
    ],
    "median_over_time_by_month": [{"month": "2025-01", "median": null}]
  },

  "tags": {
    "top": [{"tag": "dp", "problems_solved": 0, "recent_90d": 0}],
    "weak": [{"tag": "graph", "problems_solved": 0, "recent_90d": 0}],
    "radar": [{"tag": "string", "score": 0.0}]
  },

  "contests": {
    "participations": 0,
    "best_rank": null,
    "best_score": null,
    "rating_delta_sum": null,
    "list": [
      {
        "contest_id": "xxx",
        "title": "xxx",
        "start_at": "2025-01-01T10:00:00+08:00",
        "rank": 123,
        "score": 456,
        "rating_delta": null
      }
    ]
  },

  "highlights": {
    "hardest_problems": [
      {"problem_id": "p1", "title": "xxx", "difficulty": 1800, "first_ac_at": "2025-06-01"}
    ],
    "most_attempted": [
      {"problem_id": "p2", "title": "xxx", "submissions": 25, "first_ac": true}
    ],
    "fastest_ac": [
      {"problem_id": "p3", "title": "xxx", "active_seconds": null, "submissions_until_ac": 1}
    ]
  }
}
```

### 4.2 分模块接口（如果后端不想一次聚合）
- `GET /api/summary/year/overview?year=2025`
- `GET /api/summary/year/timeseries?year=2025&granularity=day|month`
- `GET /api/summary/year/habits?year=2025`
- `GET /api/summary/year/quality?year=2025`
- `GET /api/summary/year/difficulty?year=2025`
- `GET /api/summary/year/tags?year=2025`
- `GET /api/summary/year/contests?year=2025`
- `GET /api/summary/year/highlights?year=2025`

> 建议：即便分模块，也保持字段名/口径与 4.1 聚合版一致，便于前端复用。

## 5. 降级策略（后端可据此评估“缺什么还能上线”）

- **没有 difficulty**：难度模块返回 `null`/空；高光“最难题”改为“提交最多/最久攻克”。
- **没有 tags**：知识点模块整体置空；页面隐藏雷达。
- **没有 contests**：竞赛模块置空；不影响主线。
- **没有 session**：用时相关字段返回 `null`；“最久攻克”用“提交次数/跨天数”近似。

## 6. 性能与实现建议（给后端做评估用）

- **查询建议**：按 `user_id + created_at` 建索引；年度查询一般会扫一年的提交，建议有覆盖索引或预聚合。
- **聚合方式**：
  - MVP 可实时聚合（数据量不大时）
  - 数据量大建议：按天增量写入 `user_daily_agg`，年终总结直接汇总
- **缓存**：`user_id + year + timezone` 维度缓存（例如 10-60 分钟）；或生成后落库。

---

## 附：给后端的“最小提问清单”（你可以直接复制去问）

1) 能否按 `user_id + 时间范围` 拉到全量提交明细（含 verdict）？
2) 题目表里是否有 `difficulty` 与 `tags`？若没有，是否有可用的映射来源？
3) 是否能区分提交来源 `source`（daily/contest/practice）？不能也可做，但叙事会弱。
4) 时区口径怎么定（UTC 还是用户本地）？连续天数会受影响，需要统一。
